
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Validador WIN & Motor</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 16px; padding: 20px; }
    .hidden { display: none; }
    .valido { color: green; font-weight: bold; }
    .invalido { color: red; font-weight: bold; }
    .secao { border: 1px solid #ccc; padding: 15px; margin-top: 15px; border-radius: 10px; }
    .feedback-table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    .feedback-table td, .feedback-table th { border: 1px solid #ccc; padding: 5px 10px; text-align: left; }
    button { margin-right: 10px; margin-top: 10px; }
    input, select { padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>

<div style="display: flex; align-items: center; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
  <img src="logo-pm.png" alt="Logotipo Polícia Marítima" style="height: 50px; margin-right: 15px;">
  <h1 style="font-size: 1.8em; margin: 0;">Validador Marítimo</h1>
</div>
 onload="mostrarSecao('win')">
  <h2>Validador de Identificação de Embarcações</h2>
  <button onclick="mostrarSecao('win')">Validar WIN</button>
  <button onclick="mostrarSecao('motor')">Validar Motor</button>
  <button onclick="logout()">Logout</button>

  <!-- Seção WIN -->
  <div id="secaoWin" class="secao">
    <h3>Validador WIN</h3>
    <input type="text" id="winInput" placeholder="Introduz número WIN (14 ou 16 caracteres)" size="40"><br>
    <label style='font-weight:bold'>Fotografia:</label><input type="file" id="fotoWinInput" accept="image/*"><br>
    <button onclick="validarWIN()">Validar</button>
    <button onclick="window.location.href='historico-win.html'">Ver Histórico WIN</button>
    <div id="resultadoWIN"></div>
  </div>

  <!-- Seção Motor -->
  <div id="secaoMotor" class="secao hidden">
    <h3>Validador de Motor</h3>
    <label style='font-weight:bold' for="marca">Marca:</label><br>
    <select id="marca" onchange="mostrarCamposMotor()">
      <option value="">-- Selecionar marca --</option>
      <option value="Yamaha">Yamaha</option>
      <option value="Honda">Honda</option>
      <option value="MercuryIn">Mercury (Inboard)</option>
      <option value="MercuryOut">Mercury (Outboard)</option>
      <option value="Suzuki">Suzuki</option>
    </select>
    <div id="camposMotor" style="margin-top:10px;"></div>
    <label style='font-weight:bold'>Fotografia:</label><input type="file" id="fotoMotorInput" accept="image/*"><br>
    <button onclick="validarMotor()">Validar</button>
    <button onclick="window.location.href='historico-motor.html'">Ver Histórico Motores</button>
    <div id="resultadoMotor"></div>
  </div>

  <script>
    function logout() {
      window.location.href = 'login.html';
    }

    function mostrarSecao(sec) {
      ['secaoWin','secaoMotor'].forEach(id => document.getElementById(id).classList.add('hidden'));
      if (sec === 'win') document.getElementById('secaoWin').classList.remove('hidden');
      if (sec === 'motor') document.getElementById('secaoMotor').classList.remove('hidden');
    }

    function validarNumeroWIN(win) {
      const r = { valido: false, mensagem: '', campos: [] };
      win = win.replace(/-/g,'').trim().toUpperCase();
      if (![14,16].includes(win.length)) {
        r.mensagem = 'WIN inválido: deve ter 14 ou 16 caracteres.';
        return r;
      }
      const pais = win.slice(0,2), fab = win.slice(2,5);
      if (/\d/.test(pais) || /\d/.test(fab)) {
        r.mensagem = 'Códigos país/fabricante inválidos.'; return r;
      }
      const serie = win.length===14? win.slice(5,10) : win.slice(5,12);
      const mesL = win.length===14? win[10] : win[12];
      const anoP = win.length===14? win[11] : win[13];
      const anoM = win.length===14? win.slice(12) : win.slice(14);
      r.valido = true; r.mensagem = 'WIN válido.';
      r.campos = [
        { nome:'País', valor: pais, interpretacao: pais },
        { nome:'Fabricante', valor: fab, interpretacao: fab },
        { nome:'Série', valor: serie, interpretacao: 'Livre' },
        { nome:'Mês', valor: mesL, interpretacao: mesL },
        { nome:'Ano Prod.', valor: anoP, interpretacao: anoP },
        { nome:'Ano Mod.', valor: anoM, interpretacao: anoM }
      ];
      return r;
    }

    function validarWIN() {
      const w = document.getElementById('winInput').value;
      const file = document.getElementById('fotoWinInput').files[0];
      const res = validarNumeroWIN(w);
      const div = document.getElementById('resultadoWIN');

      if (!res.valido) {
        div.innerHTML = `<p class="invalido">${res.mensagem}</p>`;
        return;
      }

      let out = `<p class="valido">${res.mensagem}</p><table class="feedback-table"><tr><th style='font-weight:bold'>Campo</th><th style='font-weight:bold'>Valor</th><th style='font-weight:bold'>Interpretação</th></tr>`;
      res.campos.forEach(c => { out += `<tr><td style='font-size:15px'>${c.nome}</td><td style='font-size:15px'>${c.valor}</td><td style='font-size:15px'>${c.interpretacao}</td></tr>`; });
      out += '</table>';
      div.innerHTML = out;

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          salvarHistoricoWIN(w, res.valido, res.mensagem, e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        salvarHistoricoWIN(w, res.valido, res.mensagem, null);
      }
    }

    function salvarHistoricoWIN(win, valido, msg, foto) {
      const h = JSON.parse(localStorage.getItem('hisWIN')||'[]');
      h.unshift({ data: new Date().toLocaleString(), win, valido, msg, foto });
      localStorage.setItem('hisWIN', JSON.stringify(h));
    }

    const regrasMotor = {
      Yamaha: { regex: /^[A-Z0-9]{8,}$/ },
      Honda: { regex: /^.+$/ },
      MercuryIn: { regex: /^[0-9A-Z]{7,8}$/ },
      MercuryOut: { regex: /^[0-3][A-Z][0-9]{6}$/ },
      Suzuki: { regex: /^[A-Z]{2}[0-9]{2,3}[A-Z]*[0-9]{7}$/ }
    };

    const infoMotor = {
      Yamaha: { campos:['Etiqueta'], descricao:'Formato: código+serial', notas:'Sem Jet Drive'},
      Honda: { campos:['FrameSN','EngineSN'], descricao:'2 etiquetas (transom e bloco)', notas:'Devem coincidir'},
      MercuryIn: { campos:['TransomSN'], descricao:'Inboard Transom SN', notas:'Obrigatório'},
      MercuryOut: { campos:['OutboardSN'], descricao:'Outboard SN padrão', notas:'Prefixo 0-3'},
      Suzuki: { campos:['Etiqueta'], descricao:'DF/DT + 7 dígitos', notas:'Verificar prefixo'}
    };

    function mostrarCamposMotor() {
      const m = document.getElementById('marca').value;
      let html = '';
      if (m==='Yamaha' || m==='MercuryOut' || m==='Suzuki') {
        html = '<input id="campo1" placeholder="Insere série"><br>';
      } else if (m==='Honda') {
        html = 'Frame SN:<input id="campo1" placeholder="Frame SN"><br>' +
               'Engine SN:<input id="campo2" placeholder="Engine SN"><br>';
      } else if (m==='MercuryIn') {
        html = '<input id="campo1" placeholder="SN Transom"><br>';
      }
      document.getElementById('camposMotor').innerHTML = html;
    }

    function validarMotor() {
      const marca = document.getElementById('marca').value;
      const c1 = document.getElementById('campo1')?.value || '';
      const c2 = document.getElementById('campo2')?.value || '';
      const file = document.getElementById('fotoMotorInput').files[0];

      const regras = regrasMotor[marca];
      const info = infoMotor[marca];
      let valido = false;
      let mensagem = '';

      if (marca === 'Honda') {
        valido = regras.regex.test(c1) && regras.regex.test(c2);
        mensagem = valido ? 'Número válido para Honda' : 'Número inválido (Honda requer dois códigos válidos)';
      } else {
        valido = regras.regex.test(c1);
        mensagem = valido ? `Número válido para ${marca}` : `Número inválido para ${marca}`;
      }

      const div = document.getElementById('resultadoMotor');
      div.innerHTML = `
        <p class="${valido ? 'valido' : 'invalido'}">${mensagem}</p>
        <p><strong>Campos Esperados:</strong> ${info?.campos.join(', ') || 'N/D'}</p>
        <p><strong>Descrição:</strong> ${info?.descricao || 'Sem info'}</p>
        <p><strong>Notas:</strong> ${info?.notas || 'Sem info'}</p>
      `;

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          salvarHistoricoMotor(marca, c1, c2, valido, mensagem, e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        salvarHistoricoMotor(marca, c1, c2, valido, mensagem, null);
      }
    }

    function salvarHistoricoMotor(marca, campo1, campo2, valido, msg, foto) {
      const h = JSON.parse(localStorage.getItem('hisMotor')||'[]');
      h.unshift({ data:new Date().toLocaleString(), marca, campo1, campo2, valido, msg, foto });
      localStorage.setItem('hisMotor', JSON.stringify(h));
    }
  </script>
</body>
</html>
